<!DOCTYPE html><html lang=ja-x-mtfrom-en><head><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(h){}};this.tick("start",null,a)}var a;if(window.performance)var d=(a=window.performance.timing)&&a.responseStart;var f=0<d?new e(d):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_","_wtsrt",
d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();}).call(window);
</script><script src="https://translate.googleusercontent.com/translate/releases/twsfe_w_20180723_RC00/r/js/translate_c.js"></script><script>_intlStrings._originalText = "英語の原文テキスト:";_intlStrings._interfaceDirection="ltr";_intlStrings._interfaceAlign="left";_intlStrings._langpair="en|ja";_intlStrings._feedbackUrl="https://translate.google.com/translate_suggestion";_intlStrings._currentBy="%1$s に %2$s により翻訳されました";_intlStrings._unknown="不明";_intlStrings._suggestTranslation="翻訳を改善する"  ;_intlStrings._submit="送信";_intlStrings._suggestThanks="Google 翻訳の改善にご協力いただきありがとうございました。";_intlStrings._reverse=false;_intlStrings._staticContentPath="https://www.gstatic.com/translate/infowindow/";</script><style type="text/css">.google-src-text {display: none !important} .google-src-active-text {display: block!important;color:black!important; font-size:12px!important;font-family:arial,sans-serif!important}.google-src-active-text a {font-size:12px!important}.google-src-active-text a:link {color:#00c!important;text-decoration:underline!important}.google-src-active-text a:visited {color:purple!important;text-decoration:underline!important}.google-src-active-text a:active {color:red!important;text-decoration:underline!important}</style><meta http-equiv="X-Translated-By" content="Google"><link href=working-with-unsafe.html hreflang=en rel="alternate machine-translated-from"><base href="" target=_top /></head><body><iframe src="https://translate.google.com/translate_un?hl=ja&prev=_t&sl=en&tl=ja&lang=en&usg=ALkJrhi1BDLmdbWiRXYMNxkaJ7TdmUrvmA" width=0 height=0 frameborder=0 style="width:0px;height:0px;border:0px;display:none;"></iframe><h1> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Working with Unsafe</span>危険な作業</span> </h1><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Rust generally only gives us the tools to talk about Unsafe Rust in a scoped and binary manner.</span>錆は、一般的に、Unsafe Rustについてスコープとバイナリの方法で話すツールを提供します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Unfortunately, reality is significantly more complicated than that.</span>残念ながら、現実はそれよりもはるかに複雑です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For instance, consider the following toy function:</span>たとえば、次のようなおもちゃ関数を考えてみましょう。</span> </p><br><div data-lang=rust><div data-l="fn index(idx: usize, arr: &amp;[u8]) -&gt; Option&lt;u8&gt; {"></div><div data-l="    if idx &lt; arr.len() {"></div><div data-l="        unsafe {"></div><div data-l="            Some(*arr.get_unchecked(idx))"></div><div data-l="        }"></div><div data-l="    } else {"></div><div data-l="        None"></div><div data-l="    }"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This function is safe and correct.</span>この機能は安全で正確です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We check that the index is in bounds, and if it is, index into the array in an unchecked manner.</span>インデックスが境界内にあるかどうかを確認し、インデックスがある場合は、チェックされていない方法で配列にインデックスを付けます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">But even in such a trivial function, the scope of the unsafe block is questionable.</span>しかし、このような小さな機能であっても、安全でないブロックの範囲は疑わしい。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Consider changing the <code>&lt;</code> to a <code>&lt;=</code> :</span> <code>&lt;</code>を<code>&lt;=</code>変更することを検討してください：</span> </p><br><div data-lang=rust><div data-l="fn index(idx: usize, arr: &amp;[u8]) -&gt; Option&lt;u8&gt; {"></div><div data-l="    if idx &lt;= arr.len() {"></div><div data-l="        unsafe {"></div><div data-l="            Some(*arr.get_unchecked(idx))"></div><div data-l="        }"></div><div data-l="    } else {"></div><div data-l="        None"></div><div data-l="    }"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This program is now unsound, and yet <i>we only modified safe code</i> .</span>このプログラムは今や<i>安全では</i>ありませんが、 <i>安全なコードだけを修正しました</i> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is the fundamental problem of safety: it&#39;s non-local.</span>これは安全性の根本的な問題です。非ローカルなのです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The soundness of our unsafe operations necessarily depends on the state established by otherwise &quot;safe&quot; operations.</span>安全でない操作の健全性は、必然的に「安全な」操作によって確立された状態に依存します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Safety is modular in the sense that opting into unsafety doesn&#39;t require you to consider arbitrary other kinds of badness.</span>安全性は、安全ではないことを選択することは、あなたが任意の他の種類の悪いことを考慮する必要がないという意味でモジュラーです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For instance, doing an unchecked index into a slice doesn&#39;t mean you suddenly need to worry about the slice being null or containing uninitialized memory.</span>たとえば、スライスにチェックされていないインデックスを作成しても、スライスがヌルであるか、または初期化されていないメモリが含まれていることを心配する必要はありません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Nothing fundamentally changes.</span>根本的に変化するものはありません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">However safety <i>isn&#39;t</i> modular in the sense that programs are inherently stateful and your unsafe operations may depend on arbitrary other state.</span>しかし、プログラムは本質的にステートフルであり、安全でない操作は任意の他の状態に依存するという意味で、安全性<i>は</i>モジュール式で<i>はありません</i> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This non-locality gets much worse when we incorporate actual persistent state.</span>この非局所性は、実際の永続状態を組み込むときにはるかに悪化します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Consider a simple implementation of <code>Vec</code> :</span> <code>Vec</code>簡単な実装を考えてみましょう。</span> </p><br><div data-lang=rust><div data-l="use std::ptr;"></div><div data-l=""></div><div data-l="#// Note: This definition is naive. See the chapter on implementing Vec."></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Note: This definition is naive.</span>注：この定義は単純です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">See the chapter on implementing Vec.</span> Vecの実装に関する章を参照してください。</span> </div><div data-l="pub struct Vec&lt;T&gt; {"></div><div data-l="    ptr: *mut T,"></div><div data-l="    len: usize,"></div><div data-l="    cap: usize,"></div><div data-l=}></div><div data-l=""></div><div data-l="#// Note this implementation does not correctly handle zero-sized types."></div><div data-l="#// See the chapter on implementing Vec."></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Note this implementation does not correctly handle zero-sized types.</span>この実装はゼロサイズの型を正しく処理しないことに注意してください。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">See the chapter on implementing Vec.</span> Vecの実装に関する章を参照してください。</span> </div><div data-l="impl&lt;T&gt; Vec&lt;T&gt; {"></div><div data-l="    pub fn push(&amp;mut self, elem: T) {"></div><div data-l="        if self.len == self.cap {"></div><div data-l="#            // not important for this example"></div><div data-l="            // "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">not important for this example</span>この例では重要ではない</span> </div><div data-l="            self.reallocate();"></div><div data-l="        }"></div><div data-l="        unsafe {"></div><div data-l="            ptr::write(self.ptr.offset(self.len as isize), elem);"></div><div data-l="            self.len += 1;"></div><div data-l="        }"></div><div data-l="    }"></div><div data-l="    # fn reallocate(&amp;mut self) { }"></div><div data-l=}></div><div data-l=""></div><div data-l="# fn main() {}"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This code is simple enough to reasonably audit and informally verify.</span>このコードは、合理的に監査し、非公式に検証するのに十分単純です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now consider adding the following method:</span>次のメソッドを追加することを検討してください。</span> </p><br><div data-lang=rust,ignore><div data-l="fn make_room(&amp;mut self) {"></div><div data-l="#    // grow the capacity"></div><div data-l="    // "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">grow the capacity</span>能力を伸ばす</span> </div><div data-l="    self.cap += 1;"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This code is 100% Safe Rust but it is also completely unsound.</span>このコードは100％Safe Rustですが、完全に安全ではありません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Changing the capacity violates the invariants of Vec (that <code>cap</code> reflects the allocated space in the Vec).</span>容量を変更するとVecの不変量に​​違反します（その<code>cap</code>はVecの割り当てられたスペースを反映します）。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is not something the rest of Vec can guard against.</span> Vecの残りの部分を守ることはできません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It <i>has</i> to trust the capacity field because there&#39;s no way to verify it.</span>それを確認する方法はありませんので、それは容量フィールドを信頼する必要<i>があります</i> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Because it relies on invariants of a struct field, this <code>unsafe</code> code does more than pollute a whole function: it pollutes a whole <i>module</i> .</span>構造体フィールドの不変量に​​依存するため、この<code>unsafe</code>コードは関数全体を汚染する以上のことを行い<i>ます</i> 。 <i>モジュール</i>全体を汚染し<i>ます</i> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Generally, the only bullet-proof way to limit the scope of unsafe code is at the module boundary with privacy.</span>一般的に、安全でないコードの範囲を制限する唯一の防弾方法は、プライバシーを持つモジュールの境界です。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">However this works <i>perfectly</i> .</span>しかし、これは<i>完全に動作し</i>ます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The existence of <code>make_room</code> is <i>not</i> a problem for the soundness of Vec because we didn&#39;t mark it as public.</span> <code>make_room</code>の存在はVecの健全性にとって問題ではあり<i>ません</i> 。なぜなら私たちはそれを公にしていないからです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Only the module that defines this function can call it.</span>この関数を定義するモジュールだけが呼び出すことができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Also, <code>make_room</code> directly accesses the private fields of Vec, so it can only be written in the same module as Vec.</span>また、 <code>make_room</code>はVecのプライベートフィールドに直接アクセスするため、Vecと同じモジュールにしか書き込めません。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It is therefore possible for us to write a completely safe abstraction that relies on complex invariants.</span>したがって、複雑な不変量に依存する完全に安全な抽象化を書くことが可能です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is <i>critical</i> to the relationship between Safe Rust and Unsafe Rust.</span>これは、安全な錆と安全でない錆の関係<i>にとって非常に重要</i>です。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We have already seen that Unsafe code must trust <i>some</i> Safe code, but shouldn&#39;t trust <i>generic</i> Safe code.</span>安全でないコードは<i>いくつかの</i>セーフコードを信頼<i>する</i>必要がありますが、 <i>一般的</i>なセーフコードは信頼できません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Privacy is important to unsafe code for similar reasons: it prevents us from having to trust all the safe code in the universe from messing with our trusted state.</span>プライバシーは安全でないコードにとっても同様の理由から重要です。それは、宇宙のすべての安全なコードを信頼できる状態に陥らせることから私たちを守ることを妨げるからです。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Safety lives!</span>安全ライフ！</span> </p><br><script>_addload(function(){_setupIW('com');_csi('en','ja','working-with-unsafe.html');});</script>