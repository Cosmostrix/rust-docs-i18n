<!DOCTYPE html>
<h2>Handle a rate-limited API</h2>
<br>
<p><a href="#3reqwest">!<a class="notranslate" href="#4reqwest-badge">reqwest-badge</a></a> <a href="#3hyper">!<a class="notranslate" href="#4hyper-badge">hyper-badge</a></a> <a href="#3cat-net">!<a class="notranslate" href="#4cat-net-badge">cat-net-badge</a></a></p>
<br>
<p>This example uses the <a class="notranslate" href="#4GitHub API - Rate limiting">GitHub API - Rate limiting</a>, as an example of how to
handle remote server errors.  This example uses the <a class="notranslate" href="#4`hyper::header!`">`hyper::header!`</a> macro
to parse the response header and checks for <a class="notranslate" href="#4`reqwest::StatusCode::Forbidden`">`reqwest::StatusCode::Forbidden`</a>.
If the response exceeds the rate limit, the example waits and retries.</p>
<br>
<div data-lang="rust,no_run"><div data-l="# #[macro_use]"></div><div data-l="# extern crate error_chain;"></div><div data-l="#[macro_use]"></div><div data-l="extern crate hyper;"></div><div data-l="extern crate reqwest;"></div><div data-l=""></div><div data-l="use std::time::{Duration, UNIX_EPOCH};"></div><div data-l="use std::thread;"></div><div data-l="use reqwest::StatusCode;"></div><div data-l="#"></div><div data-l="# error_chain! {"></div><div data-l="#    foreign_links {"></div><div data-l="#        Io(std::io::Error);"></div><div data-l="#        Time(std::time::SystemTimeError);"></div><div data-l="#        Reqwest(reqwest::Error);"></div><div data-l="#    }"></div><div data-l="# }"></div><div data-l=""></div><div data-l="header! { (XRateLimitLimit, &quot;X-RateLimit-Limit&quot;) =&gt; [usize] }"></div><div data-l="header! { (XRateLimitRemaining, &quot;X-RateLimit-Remaining&quot;) =&gt; [usize] }"></div><div data-l="header! { (XRateLimitReset, &quot;X-RateLimit-Reset&quot;) =&gt; [u64] }"></div><div data-l=""></div><div data-l="fn run() -&gt; Result&lt;()&gt; {"></div><div data-l="    let url = &quot;https://api.github.com/users/rust-lang-nursery &quot;;"></div><div data-l="    let client = reqwest::Client::new();"></div><div data-l="    let response = client.get(url).send()?;"></div><div data-l=""></div><div data-l="    let rate_limit = response.headers().get::&lt;XRateLimitLimit&gt;().ok_or("></div><div data-l="        &quot;response doesn't include the expected X-RateLimit-Limit header&quot;,"></div><div data-l="    )?;"></div><div data-l=""></div><div data-l="    let rate_remaining = response.headers().get::&lt;XRateLimitRemaining&gt;().ok_or("></div><div data-l="        &quot;response doesn't include the expected X-RateLimit-Remaining header&quot;,"></div><div data-l="    )?;"></div><div data-l=""></div><div data-l="    let rate_reset_at = response.headers().get::&lt;XRateLimitReset&gt;().ok_or("></div><div data-l="        &quot;response doesn't include the expected X-RateLimit-Reset header&quot;,"></div><div data-l="    )?;"></div><div data-l=""></div><div data-l="    let rate_reset_within = Duration::from_secs(**rate_reset_at) - UNIX_EPOCH.elapsed()?;"></div><div data-l=""></div><div data-l="    if response.status() == StatusCode::Forbidden &amp;&amp; **rate_remaining == 0 {"></div><div data-l="        println!(&quot;Sleeping for {} seconds.&quot;, rate_reset_within.as_secs());"></div><div data-l="        thread::sleep(rate_reset_within);"></div><div data-l="        return run();"></div><div data-l="    }"></div><div data-l="    else {"></div><div data-l="        println!("></div><div data-l="            &quot;Rate limit is currently {}/{}, the reset of this limit will be within {} seconds.&quot;,"></div><div data-l="            **rate_remaining,"></div><div data-l="            **rate_limit,"></div><div data-l="            rate_reset_within.as_secs(),"></div><div data-l="        );"></div><div data-l="    }"></div><div data-l=""></div><div data-l="    Ok(())"></div><div data-l="}"></div><div data-l="#"></div><div data-l="# quick_main!(run);"></div></div>
<br>
<a class="notranslate" href="#1https://doc.servo.org/hyper/header/index.html#defining-custom-headers">`hyper::header!`</a>
<a class="notranslate" href="#1https://docs.rs/reqwest/*/reqwest/enum.StatusCode.html#variant.Forbidden">`reqwest::StatusCode::Forbidden`</a>