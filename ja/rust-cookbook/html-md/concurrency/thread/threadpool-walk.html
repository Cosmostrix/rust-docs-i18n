<!DOCTYPE html>
<h2>Calculate SHA1 sum of iso files concurrently</h2>
<br>
<p><a href="#3threadpool">!<a class="notranslate" href="#4threadpool-badge">threadpool-badge</a></a> <a href="#3num_cpus">!<a class="notranslate" href="#4num_cpus-badge">num_cpus-badge</a></a> <a href="#3walkdir">!<a class="notranslate" href="#4walkdir-badge">walkdir-badge</a></a> <a href="#3ring">!<a class="notranslate" href="#4ring-badge">ring-badge</a></a> <a href="#3cat-concurrency">!<a class="notranslate" href="#4cat-concurrency-badge">cat-concurrency-badge</a></a><a href="#3cat-filesystem">!<a class="notranslate" href="#4cat-filesystem-badge">cat-filesystem-badge</a></a></p>
<br>
<p>This example calculates the SHA1 for every file with iso extension in the
current directory. A threadpool generates threads equal to the number of cores
present in the system found with <a class="notranslate" href="#4`num_cpus::get`">`num_cpus::get`</a>.  <a class="notranslate" href="#4`Walkdir::new`">`Walkdir::new`</a> iterates
the current directory and calls <a class="notranslate" href="#4`execute`">`execute`</a> to perform the operations of reading
and computing SHA1 hash.</p>
<br>
<div data-lang="rust,no_run"><div data-l="# #[macro_use]"></div><div data-l="# extern crate error_chain;"></div><div data-l="extern crate walkdir;"></div><div data-l="extern crate ring;"></div><div data-l="extern crate num_cpus;"></div><div data-l="extern crate threadpool;"></div><div data-l=""></div><div data-l="# error_chain! {"></div><div data-l="#     foreign_links {"></div><div data-l="#         Io(std::io::Error);"></div><div data-l="#     }"></div><div data-l="# }"></div><div data-l="#"></div><div data-l="use walkdir::WalkDir;"></div><div data-l="use std::fs::File;"></div><div data-l="use std::io::{BufReader, Read};"></div><div data-l="use std::path::Path;"></div><div data-l="use threadpool::ThreadPool;"></div><div data-l="use std::sync::mpsc::channel;"></div><div data-l="use ring::digest::{Context, Digest, SHA1};"></div><div data-l=""></div><div data-l="#//# // Verify the iso extension"></div><div data-l="# // ">Verify the iso extension</div><div data-l="# fn is_iso(entry: &amp;Path) -&gt; bool {"></div><div data-l="#     match entry.extension() {"></div><div data-l="#         Some(e) if e.to_string_lossy().to_lowercase() == &quot;iso&quot; =&gt; true,"></div><div data-l="#         _ =&gt; false,"></div><div data-l="#     }"></div><div data-l="# }"></div><div data-l="#"></div><div data-l="fn compute_digest&lt;P: AsRef&lt;Path&gt;&gt;(filepath: P) -&gt; Result&lt;(Digest, P)&gt; {"></div><div data-l="    let mut buf_reader = BufReader::new(File::open(&amp;filepath)?);"></div><div data-l="    let mut context = Context::new(&amp;SHA1);"></div><div data-l="    let mut buffer = [0; 1024];"></div><div data-l=""></div><div data-l="    loop {"></div><div data-l="        let count = buf_reader.read(&amp;mut buffer)?;"></div><div data-l="        if count == 0 {"></div><div data-l="            break;"></div><div data-l="        }"></div><div data-l="        context.update(&amp;buffer[..count]);"></div><div data-l="    }"></div><div data-l=""></div><div data-l="    Ok((context.finish(), filepath))"></div><div data-l="}"></div><div data-l=""></div><div data-l="fn run() -&gt; Result&lt;()&gt; {"></div><div data-l="    let pool = ThreadPool::new(num_cpus::get());"></div><div data-l=""></div><div data-l="    let (tx, rx) = channel();"></div><div data-l=""></div><div data-l="    for entry in WalkDir::new(&quot;/home/user/Downloads&quot;)"></div><div data-l="        .follow_links(true)"></div><div data-l="        .into_iter()"></div><div data-l="        .filter_map(|e| e.ok())"></div><div data-l="        .filter(|e| !e.path().is_dir() &amp;&amp; is_iso(e.path())) {"></div><div data-l="            let path = entry.path().to_owned();"></div><div data-l="            let tx = tx.clone();"></div><div data-l="            pool.execute(move || {"></div><div data-l="                let digest = compute_digest(path);"></div><div data-l="                tx.send(digest).expect(&quot;Could not send data!&quot;);"></div><div data-l="            });"></div><div data-l="        }"></div><div data-l=""></div><div data-l="    drop(tx);"></div><div data-l="    for t in rx.iter() {"></div><div data-l="        let (sha, path) = t?;"></div><div data-l="        println!(&quot;{:?} {:?}&quot;, sha, path);"></div><div data-l="    }"></div><div data-l="    Ok(())"></div><div data-l="}"></div><div data-l="#"></div><div data-l="# quick_main!(run);"></div></div>
<br>
<a class="notranslate" href="#1https://docs.rs/threadpool/*/threadpool/struct.ThreadPool.html#method.execute">`execute`</a>
<a class="notranslate" href="#1https://docs.rs/num_cpus/*/num_cpus/fn.get.html">`num_cpus::get`</a>
<a class="notranslate" href="#1https://docs.rs/walkdir/*/walkdir/struct.WalkDir.html#method.new">`Walkdir::new`</a>