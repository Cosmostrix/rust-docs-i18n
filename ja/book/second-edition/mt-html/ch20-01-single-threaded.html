<!DOCTYPE html><html lang=ja-x-mtfrom-en><head><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(h){}};this.tick("start",null,a)}var a;if(window.performance)var d=(a=window.performance.timing)&&a.responseStart;var f=0<d?new e(d):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_","_wtsrt",
d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();}).call(window);
</script><script src="https://translate.googleusercontent.com/translate/releases/twsfe_w_20180709_RC00/r/js/translate_c.js"></script><script>_intlStrings._originalText = "英語の原文テキスト:";_intlStrings._interfaceDirection="ltr";_intlStrings._interfaceAlign="left";_intlStrings._langpair="en|ja";_intlStrings._feedbackUrl="https://translate.google.com/translate_suggestion";_intlStrings._currentBy="%1$s に %2$s により翻訳されました";_intlStrings._unknown="不明";_intlStrings._suggestTranslation="翻訳を改善する"  ;_intlStrings._submit="送信";_intlStrings._suggestThanks="Google 翻訳の改善にご協力いただきありがとうございました。";_intlStrings._reverse=false;_intlStrings._staticContentPath="https://www.gstatic.com/translate/infowindow/";</script><style type="text/css">.google-src-text {display: none !important} .google-src-active-text {display: block!important;color:black!important; font-size:12px!important;font-family:arial,sans-serif!important}.google-src-active-text a {font-size:12px!important}.google-src-active-text a:link {color:#00c!important;text-decoration:underline!important}.google-src-active-text a:visited {color:purple!important;text-decoration:underline!important}.google-src-active-text a:active {color:red!important;text-decoration:underline!important}</style><meta http-equiv="X-Translated-By" content="Google"><link href=ch20-01-single-threaded.html hreflang=en rel="alternate machine-translated-from"><base href="" target=_top /></head><body><iframe src="https://translate.google.com/translate_un?hl=ja&prev=_t&sl=en&tl=ja&lang=en&usg=ALkJrhi1BDLmdbWiRXYMNxkaJ7TdmUrvmA" width=0 height=0 frameborder=0 style="width:0px;height:0px;border:0px;display:none;"></iframe><h2> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Building a Single-Threaded Web Server</span>シングルスレッドWebサーバーの構築</span> </h2><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ll start by getting a single-threaded web server working.</span>まず、シングルスレッドのWebサーバーを動作させることから始めます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Before we begin, let&#39;s look at a quick overview of the protocols involved in building web servers.</span>はじめに、Webサーバーの構築に関わるプロトコルの概要を見ていきましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The details of these protocols are beyond the scope of this book, but a brief overview will give you the information you need.</span>これらのプロトコルの詳細は本書の範囲を超えていますが、必要な情報が簡単に表示されます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The two main protocols involved in web servers are the <i>Hypertext Transfer Protocol</i> <i>(HTTP)</i> and the <i>Transmission Control Protocol</i> <i>(TCP)</i> .</span> Webサーバーに関連する2つの主なプロトコルは、 <i>HTTP（</i> <i>Hypertext Transfer Protocol</i> <i>）</i>と<i>TCP（</i> <i>Transmission Control Protocol</i> <i>）</i>です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Both protocols are <i>request-response</i> protocols, meaning a <i>client</i> initiates requests and a <i>server</i> listens to the requests and provides a response to the client.</span>どちらのプロトコルも<i>要求応答</i>プロトコルで、 <i>クライアント</i>が要求を開始し、 <i>サーバー</i>が要求をリッスンしてクライアントに応答を提供します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The contents of those requests and responses are defined by the protocols.</span>これらの要求と応答の内容は、プロトコルによって定義されます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TCP is the lower-level protocol that describes the details of how information gets from one server to another but doesn&#39;t specify what that information is.</span> TCPは、あるサーバーから別のサーバーに情報を取得する方法の詳細を記述する下位レベルのプロトコルですが、その情報が何であるかは指定していません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">HTTP builds on top of TCP by defining the contents of the requests and responses.</span> HTTPは、要求と応答の内容を定義することによって、TCPの上に構築されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It&#39;s technically possible to use HTTP with other protocols, but in the vast majority of cases, HTTP sends its data over TCP.</span> HTTPを他のプロトコルと併用することは技術的に可能ですが、大部分の場合、HTTPはTCP経由でデータを送信します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ll work with the raw bytes of TCP and HTTP requests and responses.</span>私たちはTCPとHTTPリクエストと応答の生のバイトを扱います。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Listening to the TCP Connection</span> TCP接続のリッスン</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Our web server needs to listen to a TCP connection, so that&#39;s the first part we&#39;ll work on.</span>私たちのWebサーバーはTCP接続を聞く必要があります。これが最初に作業する部分です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The standard library offers a <code>std::net</code> module that lets us do this.</span>標準ライブラリは、これを可能にする<code>std::net</code>モジュールを提供しています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s make a new project in the usual fashion:</span>通常の方法で新しいプロジェクトを作ってみましょう：</span> </p><br><div data-lang=text><div data-l="$ cargo new hello --bin"></div><div data-l="     Created binary (application) `hello` project"></div><div data-l="$ cd hello"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now enter the code in Listing 20-1 in <i>src/main.rs</i> to start.</span>リスト20-1のコードを<i>src / main.rsに入力</i>して開始します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This code will listen at the address <code>127.0.0.1:7878</code> for incoming TCP streams.</span>このコードは、着信TCPストリームのアドレス<code>127.0.0.1:7878</code>でリッスンします。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">When it gets an incoming stream, it will print <code>Connection established€</code> .</span>着信ストリームを取得すると、 <code>Connection established€</code>ます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust,no_run><div data-l="use std::net::TcpListener;"></div><div data-l=""></div><div data-l="fn main() {"></div><div data-l="    let listener = TcpListener::bind(&quot;127.0.0.1:7878&quot;).unwrap();"></div><div data-l=""></div><div data-l="    for stream in listener.incoming() {"></div><div data-l="        let stream = stream.unwrap();"></div><div data-l=""></div><div data-l="        println!(&quot;Connection established!&quot;);"></div><div data-l="    }"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-1: Listening for incoming streams and printing a message when we receive a stream</span></span> <span class=caption>リスト20-1：受信したストリームをリッスンし、ストリームを受信したときにメッセージを出力する</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Using <code>TcpListener</code> , we can listen for TCP connections at the address <code>127.0.0.1:7878</code> .</span> <code>TcpListener</code>を使用して、アドレス<code>127.0.0.1:7878</code> TCP接続を<code>TcpListener</code>できます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In the address, the section before the colon is an IP address representing your computer (this is the same on every computer and doesn&#39;t represent the authors&#39; computer specifically), and <code>7878</code> is the port.</span>アドレスでは、コロンの前のセクションは、お使いのコンピュータを表すIPアドレスです（これはすべてのコンピュータで同じで、作成者のコンピュータを特に表すものではありません） <code>7878</code>はポートです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ve chosen this port for two reasons: HTTP is normally accepted on this port, and 7878 is <i>rust</i> typed on a telephone.</span> HTTPは、通常、このポートで受け入れられ、および7878は、電話に入力された<i>錆</i>である：我々は2つの理由から、このポートを選択しました。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>bind</code> function in this scenario works like the <code>new</code> function in that it will return a new <code>TcpListener</code> instance.</span>このシナリオの<code>bind</code>関数は、新しい<code>TcpListener</code>インスタンスを返すという点で、 <code>new</code>関数と同様に機能します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The reason the function is called <code>bind</code> is that in networking, connecting to a port to listen to is known as “binding to a port.”</span>この関数が<code>bind</code>と呼ばれる理由は、ネットワーキングでは、listenするポートに接続することを「ポートへのバインディング」と呼びます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>bind</code> function returns a <code>Result&lt;T, E&gt;</code> , which indicates that binding might fail.</span> <code>bind</code>関数は、バインディングが失敗する可能性があることを示す<code>Result&lt;T, E&gt;</code>返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For example, connecting to port 80 requires administrator privileges (nonadministrators can listen only on ports higher than 1024), so if we tried to connect to port 80 without being an administrator, binding wouldn&#39;t work.</span>たとえば、ポート80に接続するには管理者権限が必要です（非管理者は1024以上のポートでしか聞くことができません）。したがって、管理者でなくてもポート80に接続しようとするとバインディングは機能しません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">As another example, binding wouldn&#39;t work if we ran two instances of our program and so had two programs listening to the same port.</span>別の例として、プログラムの2つのインスタンスを実行し、同じポートをリッスンする2つのプログラムがある場合、バインディングは機能しません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Because we&#39;re writing a basic server just for learning purposes, we won&#39;t worry about handling these kinds of errors;</span>学習目的のためだけに基本的なサーバーを作成しているので、この種のエラーの処理については心配しません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">instead, we use <code>unwrap</code> to stop the program if errors happen.</span>代わりに、エラーが発生した場合に<code>unwrap</code>を使用してプログラムを停止します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>incoming</code> method on <code>TcpListener</code> returns an iterator that gives us a sequence of streams (more specifically, streams of type <code>TcpStream</code> ).</span> <code>TcpListener</code>の<code>incoming</code>メソッドは、一連のストリーム（より具体的には、 <code>TcpStream</code>型のストリーム）を返すイテレータを返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">A single <i>stream</i> represents an open connection between the client and the server.</span>単一の<i>ストリーム</i>は、クライアントとサーバーの間のオープンな接続を表します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">A <i>connection</i> is the name for the full request and response process in which a client connects to the server, the server generates a response, and the server closes the connection.</span> <i>接続</i>とは、クライアントがサーバーに接続し、サーバーが応答を生成し、サーバーが接続を閉じる完全な要求および応答プロセスの名前です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">As such, <code>TcpStream</code> will read from itself to see what the client sent and then allow us to write our response to the stream.</span>そのため、 <code>TcpStream</code>はクライアントから何を送信したかを確認し、応答をストリームに書き込むことができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Overall, this <code>for</code> loop will process each connection in turn and produce a series of streams for us to handle.</span>全体として、この<code>for</code>ループは順番に各接続を処理し、処理する一連のストリームを生成します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For now, our handling of the stream consists of calling <code>unwrap</code> to terminate our program if the stream has any errors;</span>今のところ、ストリームの処理では、ストリームにエラーがあればプログラムを終了するために<code>unwrap</code>を呼び出すことからなります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">if there aren&#39;t any errors, the program prints a message.</span>エラーがなければ、プログラムはメッセージを出力します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ll add more functionality for the success case in the next listing.</span>次のリストに成功例の機能を追加します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The reason we might receive errors from the <code>incoming</code> method when a client connects to the server is that we&#39;re not actually iterating over connections.</span>クライアントがサーバーに接続するときに<code>incoming</code>メソッドからエラーを受け取る理由は、実際に接続を繰り返すわけではないからです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Instead, we&#39;re iterating over <i>connection attempts</i> .</span>代わりに、私たちは<i>接続の試行を</i>繰り返してい<i>ます</i> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The connection might not be successful for a number of reasons, many of them operating system specific.</span>多くの理由で、オペレーティングシステム固有の多くの理由で、接続が成功しない可能性があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For example, many operating systems have a limit to the number of simultaneous open connections they can support;</span>たとえば、多くのオペレーティングシステムでは、サポートできる同時オープン接続の数に制限があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">new connection attempts beyond that number will produce an error until some of the open connections are closed.</span>その番号を超えて新しい接続を試みると、開いている接続の一部が閉じられるまでエラーが発生します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s try running this code!</span>このコードを実行しよう！</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Invoke <code>cargo run</code> in the terminal and then load <i>127.0.0.1:7878</i> in a web browser.</span>端末で<code>cargo run</code>してから、ウェブブラウザで<i>127.0.0.1：7878</i>をロードします。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The browser should show an error message like “Connection reset,” because the server isn&#39;t currently sending back any data.</span>サーバーが現在データを返送していないため、ブラウザに「Connection reset」のようなエラーメッセージが表示されるはずです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">But when you look at your terminal, you should see several messages that were printed when the browser connected to the server!</span>しかし、端末を見ると、ブラウザがサーバに接続されているときにいくつかのメッセージが表示されるはずです。</span> </p><br><div data-lang=text><div data-l="     Running `target/debug/hello`"></div><div data-l="Connection established!"></div><div data-l="Connection established!"></div><div data-l="Connection established!"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Sometimes, you&#39;ll see multiple messages printed for one browser request;</span> 1つのブラウザ要求に対して複数のメッセージが表示されることがあります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">the reason might be that the browser is making a request for the page as well as a request for other resources, like the <i>favicon.ico</i> icon that appears in the browser tab.</span>その理由は、ブラウザーがページの要求とブラウザー・タブに表示される<i>favicon.ico</i>アイコンのような他のリソースの要求をしているためです。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It could also be that the browser is trying to connect to the server multiple times because the server isn&#39;t responding with any data.</span>また、サーバーが何のデータでも応答していないため、ブラウザーがサーバーに複数回接続しようとしている可能性があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">When <code>stream</code> goes out of scope and is dropped at the end of the loop, the connection is closed as part of the <code>drop</code> implementation.</span> <code>stream</code>が有効範囲外になり、ループの最後に<code>drop</code>されると、接続は<code>drop</code>実装の一部として閉じられます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Browsers sometimes deal with closed connections by retrying, because the problem might be temporary.</span>ブラウザーは、問題が一時的である可能性があるため、再試行によってクローズされた接続を処理することがあります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The important factor is that we&#39;ve successfully gotten a handle to a TCP connection!</span>重要な要素は、TCP接続の処理に成功したことです。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Remember to stop the program by pressing <span class=keystroke>ctrl-c</span> when you&#39;re done running a particular version of the code.</span>特定のバージョンのコードの実行が終了したら、 <span class=keystroke>ctrl-cを</span>押してプログラムを停止することを忘れないでください。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then restart <code>cargo run</code> after you&#39;ve made each set of code changes to make sure you&#39;re running the newest code.</span>次に、最新のコードを実行していることを確認するために、各コードセットを変更した後で、 <code>cargo run</code>再開します。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Reading the Request</span>リクエストを読む</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s implement the functionality to read the request from the browser!</span>ブラウザからリクエストを読み込む機能を実装しましょう！</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">To separate the concerns of first getting a connection and then taking some action with the connection, we&#39;ll start a new function for processing connections.</span>最初に接続を取得してから接続で何らかのアクションをとることを避けるために、接続処理のための新しい機能を開始します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In this new <code>handle_connection</code> function, we&#39;ll read data from the TCP stream and print it so we can see the data being sent from the browser.</span>この新しい<code>handle_connection</code>関数では、TCPストリームからデータを読み取り、それを印刷してブラウザから送信されたデータを見ることができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Change the code to look like Listing 20-2.</span>リスト20-2のようにコードを変更します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust,no_run><div data-l="use std::io::prelude::*;"></div><div data-l="use std::net::TcpStream;"></div><div data-l="use std::net::TcpListener;"></div><div data-l=""></div><div data-l="fn main() {"></div><div data-l="    let listener = TcpListener::bind(&quot;127.0.0.1:7878&quot;).unwrap();"></div><div data-l=""></div><div data-l="    for stream in listener.incoming() {"></div><div data-l="        let stream = stream.unwrap();"></div><div data-l=""></div><div data-l="        handle_connection(stream);"></div><div data-l="    }"></div><div data-l=}></div><div data-l=""></div><div data-l="fn handle_connection(mut stream: TcpStream) {"></div><div data-l="    let mut buffer = [0; 512];"></div><div data-l=""></div><div data-l="    stream.read(&amp;mut buffer).unwrap();"></div><div data-l=""></div><div data-l="    println!(&quot;Request: {}&quot;, String::from_utf8_lossy(&amp;buffer[..]));"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-2: Reading from the <code>TcpStream</code> and printing the data</span></span> <span class=caption>リスト20-2： <code>TcpStream</code>からの<code>TcpStream</code>とデータの印刷</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We bring <code>std::io::prelude</code> into scope to get access to certain traits that let us read from and write to the stream.</span> <code>std::io::prelude</code>をスコープに持っていくことで、ストリームの読み書きを可能にする特定の特性にアクセスできます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In the <code>for</code> loop in the <code>main</code> function, instead of printing a message that says we made a connection, we now call the new <code>handle_connection</code> function and pass the <code>stream</code> to it.</span> <code>main</code>関数の<code>for</code>ループでは、接続したことを示すメッセージを出力する代わりに、新しい<code>handle_connection</code>関数を呼び出して<code>stream</code>を渡し<code>stream</code> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In the <code>handle_connection</code> function, we&#39;ve made the <code>stream</code> parameter mutable.</span> <code>handle_connection</code>関数では、 <code>stream</code>パラメータを変更可能にしました。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The reason is that the <code>TcpStream</code> instance keeps track of what data it returns to us internally.</span>その理由は、 <code>TcpStream</code>インスタンスが内部的に私たちに返すデータを追跡するからです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It might read more data than we asked for and save that data for the next time we ask for data.</span>私たちが求めたデータよりも多くのデータを読んで、次にデータを要求するときにそのデータを保存するかもしれません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It therefore needs to be <code>mut</code> because its internal state might change;</span>したがって、内部状態が変化する可能性があるため、 <code>mut</code>ある必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">usually, we think of “reading” as not needing mutation, but in this case we need the <code>mut</code> keyword.</span>通常は、「読み込み」は突然変異を必要としないと考えますが、この場合は<code>mut</code>キーワードが必要です。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Next, we need to actually read from the stream.</span>次に、実際にストリームから読み込む必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We do this in two steps: first, we declare a <code>buffer</code> on the stack to hold the data that is read in. We&#39;ve made the buffer 512 bytes in size, which is big enough to hold the data of a basic request and sufficient for our purposes in this chapter.</span>これは、まず2つのステップで行います。まず、読み込まれたデータを保持する<code>buffer</code>をスタックに宣言します。バッファのサイズを512バイトにしました。これは、基本要求のデータを保持するのに十分な大きさであり、この章の目的のために。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If we wanted to handle requests of an arbitrary size, buffer management would need to be more complicated;</span>任意のサイズのリクエストを処理したい場合、バッファ管理はより複雑になる必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">we&#39;ll keep it simple for now.</span>私たちは今それを簡単に保つつもりです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We pass the buffer to <code>stream.read</code> , which will read bytes from the <code>TcpStream</code> and put them in the buffer.</span>バッファを<code>stream.read</code> 。これは、 <code>TcpStream</code>からバイトを読み込み、バッファに格納します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Second, we convert the bytes in the buffer to a string and print that string.</span>次に、バッファ内のバイトを文字列に変換して出力します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>String::from_utf8_lossy</code> function takes a <code>&amp;[u8]</code> and produces a <code>String</code> from it.</span> <code>String::from_utf8_lossy</code>関数は<code>&amp;[u8]</code>をとり、そこから<code>String</code>を生成します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The “lossy” part of the name indicates the behavior of this function when it sees an invalid UTF-8 sequence: it will replace the invalid sequence with <code> </code> , the <code>U+FFFD REPLACEMENT CHARACTER</code> .</span>それは不正なUTF-8シーケンスを見ているときに名前の「不可逆」の部分は、この関数の動作を示しています。それは、と無効な配列を置換します<code>U+FFFD REPLACEMENT CHARACTER</code> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">You might see replacement characters for characters in the buffer that aren&#39;t filled by request data.</span>要求データで満たされていないバッファ内の文字の置換文字が表示されることがあります。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s try this code!</span>このコードを試してみましょう！</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Start the program and make a request in a web browser again.</span>プログラムを起動して、Webブラウザでリクエストをもう一度行います。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Note that we&#39;ll still get an error page in the browser, but our program&#39;s output in the terminal will now look similar to this:</span>ブラウザにもエラーページが表示されますが、端末でのプログラムの出力は次のようになります。</span> </p><br><div data-lang=text><div data-l="$ cargo run"></div><div data-l="   Compiling hello v0.1.0 (file:///projects/hello)"></div><div data-l="    Finished dev [unoptimized + debuginfo] target(s) in 0.42 secs"></div><div data-l="     Running `target/debug/hello`"></div><div data-l="Request: GET / HTTP/1.1"></div><div data-l="Host: 127.0.0.1:7878"></div><div data-l="User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101"></div><div data-l=Firefox/52.0></div><div data-l="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"></div><div data-l="Accept-Language: en-US,en;q=0.5"></div><div data-l="Accept-Encoding: gzip, deflate"></div><div data-l="Connection: keep-alive"></div><div data-l="Upgrade-Insecure-Requests: 1"></div><div data-l="                                    "></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Depending on your browser, you might get slightly different output.</span>お使いのブラウザによっては、出力が多少異なる場合があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now that we&#39;re printing the request data, we can see why we get multiple connections from one browser request by looking at the path after <code>Request: GET</code> .</span>要求データを印刷するので、 <code>Request: GET</code>後のパスを調べることで、1つのブラウザ要求から複数の接続を取得する理由がわかります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If the repeated connections are all requesting <i>/</i> , we know the browser is trying to fetch <i>/</i> repeatedly because it&#39;s not getting a response from our program.</span>繰り返される接続がすべて<i>/</i>を要求している場合、ブラウザがプログラムからの応答を得ていないので、ブラウザがフェッチ<i>/</i>繰り返しを試みていることがわかります。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s break down this request data to understand what the browser is asking of our program.</span>このリクエストデータを分解して、ブラウザがプログラムに対して求めていることを理解してみましょう。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">A Closer Look at an HTTP Request</span> HTTPリクエストの詳細</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">HTTP is a text-based protocol, and a request takes this format:</span> HTTPはテキストベースのプロトコルであり、要求は次の形式をとります。</span> </p><br><div data-lang=text><div data-l="Method Request-URI HTTP-Version CRLF"></div><div data-l="headers CRLF"></div><div data-l=message-body></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The first line is the <i>request line</i> that holds information about what the client is requesting.</span>最初の行は、クライアントが要求しているものに関する情報を保持する<i>要求行</i>です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The first part of the request line indicates the <i>method</i> being used, such as <code>GET</code> or <code>POST</code> , which describes how the client is making this request.</span>要求行の最初の部分は、クライアントがこの要求をどのようにしているかを記述する<code>GET</code>や<code>POST</code>など、使用されている<i>メソッドを</i>示します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Our client used a <code>GET</code> request.</span>私たちのクライアントは<code>GET</code>リクエストを使用しました。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The next part of the request line is <i>/</i> , which indicates the <i>Uniform Resource Identifier</i> <i>(URI)</i> the client is requesting: a URI is almost, but not quite, the same as a <i>Uniform Resource Locator</i> <i>(URL)</i> .</span>要求行の次の部分は<i>/です</i> 。これは、クライアントが要求しているURI <i>（</i> <i>Uniform Resource Identifier</i> <i>）</i>を示し<i>ます.URL</i>はほぼ同じではありませんが、 <i>Uniform Resource Locator</i> <i>（URL）</i>とほとんど同じです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The difference between URIs and URLs isn&#39;t important for our purposes in this chapter, but the HTTP spec uses the term URI, so we can just mentally substitute URL for URI here.</span> URIとURLの違いはこの章の目的では重要ではありませんが、HTTP仕様ではURIという用語が使用されています。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The last part is the HTTP version the client uses, and then the request line ends in a <i>CRLF sequence</i> .</span>最後の部分は、クライアントが使用するHTTPバージョンであり、要求ラインは<i>CRLFシーケンスで</i>終了し<i>ます</i> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">(CRLF stands for <i>carriage return</i> and <i>line feed</i> , which are terms from the typewriter days!) The CRLF sequence can also be written as <code>\r\n</code> , where <code>\r</code> is a carriage return and <code>\n</code> is a line feed.</span> （CRLFは<i>キャリッジリターン</i>と<i>改行</i>を表しますが、タイプライターの日からの用語です）。CRLFシーケンスは<code>\r\n</code>と書くこともできます。 <code>\r</code>はキャリッジリターン、 <code>\n</code>はラインフィードです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The CRLF sequence separates the request line from the rest of the request data.</span> CRLFシーケンスは、要求ラインを残りの要求データから分離します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Note that when the CRLF is printed, we see a new line start rather than <code>\r\n</code> .</span> CRLFが印刷されると、 <code>\r\n</code>ではなく新しい行が開始されることに注意してください。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Looking at the request line data we received from running our program so far, we see that <code>GET</code> is the method, <i>/</i> is the request URI, and <code>HTTP/1.1</code> is the version.</span>これまでのプログラムの実行から得られたリクエストラインデータを見ると、 <code>GET</code>がメソッド、 <i>/</i>はリクエストURI、 <code>HTTP/1.1</code>はバージョンです。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">After the request line, the remaining lines starting from <code>Host:</code> onward are headers.</span>要求行の後、 <code>Host:</code>以降を始める残りの行はヘッダーです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>GET</code> requests have no body.</span> <code>GET</code>リクエストには本文がありません。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Try making a request from a different browser or asking for a different address, such as <i>127.0.0.1:7878/test</i> , to see how the request data changes.</span>別のブラウザからリクエストを行うか、 <i>127.0.0.1:7878/test</i>などの別のアドレスをリクエストしてリクエストデータの変更方法を確認してください。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now that we know what the browser is asking for, let&#39;s send back some data!</span>ブラウザが何を求めているのか分かったので、いくつかのデータを送り返しましょう！</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Writing a Response</span>レスポンスの作成</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now we&#39;ll implement sending data in response to a client request.</span>次に、クライアントからの要求に応じてデータを送信する実装を行います。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Responses have the following format:</span>レスポンスの形式は次のとおりです。</span> </p><br><div data-lang=text><div data-l="HTTP-Version Status-Code Reason-Phrase CRLF"></div><div data-l="headers CRLF"></div><div data-l=message-body></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The first line is a <i>status line</i> that contains the HTTP version used in the response, a numeric status code that summarizes the result of the request, and a reason phrase that provides a text description of the status code.</span>最初の行は、応答、要求の結果を要約する数値ステータスコード、およびステータスコードのテキスト説明を提供する理由句で使用されるHTTPのバージョンが含まれている<i>ステータス行</i>です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">After the CRLF sequence are any headers, another CRLF sequence, and the body of the response.</span> CRLFシーケンスの後には、ヘッダー、別のCRLFシーケンス、および応答本体があります。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Here is an example response that uses HTTP version 1.1, has a status code of 200, an OK reason phrase, no headers, and no body:</span> HTTPバージョン1.1を使用し、ステータスコード200、OK理由フレーズ、ヘッダーなし、本文なしのレスポンスの例を次に示します。</span> </p><br><div data-lang=text><div data-l="HTTP/1.1 200 OK\r\n\r\n"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The status code 200 is the standard success response.</span>ステータスコード200が標準的な成功応答です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The text is a tiny successful HTTP response.</span>テキストは小さな成功したHTTPレスポンスです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s write this to the stream as our response to a successful request!</span>成功したリクエストに対する私たちの応答として、これをストリームに書きましょう！</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">From the <code>handle_connection</code> function, remove the <code>println€</code> that was printing the request data and replace it with the code in Listing 20-3.</span> <code>handle_connection</code>関数から、リクエストデータを出力していた<code>println€</code>削除し、リスト20-3のコードに置き換えます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust><div data-l="# use std::io::prelude::*;"></div><div data-l="# use std::net::TcpStream;"></div><div data-l="fn handle_connection(mut stream: TcpStream) {"></div><div data-l="    let mut buffer = [0; 512];"></div><div data-l=""></div><div data-l="    stream.read(&amp;mut buffer).unwrap();"></div><div data-l=""></div><div data-l="    let response = &quot;HTTP/1.1 200 OK\r\n\r\n&quot;;"></div><div data-l=""></div><div data-l="    stream.write(response.as_bytes()).unwrap();"></div><div data-l="    stream.flush().unwrap();"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-3: Writing a tiny successful HTTP response to the stream</span></span> <span class=caption>リスト20-3：小さな成功したHTTPレスポンスをストリームに書き込む</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The first new line defines the <code>response</code> variable that holds the success message&#39;s data.</span>最初の改行は、成功メッセージのデータを保持する<code>response</code>変数を定義します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then we call <code>as_bytes</code> on our <code>response</code> to convert the string data to bytes.</span>次に、 <code>response</code> <code>as_bytes</code>を呼び出して、文字列データをバイトに変換します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>write</code> method on <code>stream</code> takes a <code>&amp;[u8]</code> and sends those bytes directly down the connection.</span> <code>stream</code>上の<code>write</code>メソッドは<code>&amp;[u8]</code>を取り、それらのバイトを直接接続の下に送ります。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Because the <code>write</code> operation could fail, we use <code>unwrap</code> on any error result as before.</span> <code>write</code>操作が失敗する可能性があるため、以前と同様にエラー結果に対して<code>unwrap</code>を使用します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Again, in a real application you would add error handling here.</span>ここでも、実際のアプリケーションでエラー処理を追加します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Finally, <code>flush</code> will wait and prevent the program from continuing until all the bytes are written to the connection;</span>最後に、 <code>flush</code>は待機し、すべてのバイトが接続に書き込まれるまでプログラムが続かないようにします。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>TcpStream</code> contains an internal buffer to minimize calls to the underlying operating system.</span> <code>TcpStream</code>は、基になるオペレーティングシステムへの呼び出しを最小限に抑えるための内部バッファが含まれています。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">With these changes, let&#39;s run our code and make a request.</span>これらの変更により、コードを実行してリクエストを行いましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;re no longer printing any data to the terminal, so we won&#39;t see any output other than the output from Cargo.</span>私たちはもはや端末にデータを印刷していないので、Cargoからの出力以外の出力は表示されません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">When you load <i>127.0.0.1:7878</i> in a web browser, you should get a blank page instead of an error.</span> Webブラウザで<i>127.0.0.1：7878</i>を読み込むと、エラーではなく空白のページが表示されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">You&#39;ve just hand-coded an HTTP request and response!</span> HTTPリクエストとレスポンスを手作業でコーディングしただけです！</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Returning Real HTML</span>リアルHTMLを返す</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s implement the functionality for returning more than a blank page.</span>ブランクページ以上を返す機能を実装しましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Create a new file, <i>hello.html</i> , in the root of your project directory, not in the <i>src</i> directory.</span> <i>src</i>ディレクトリではなく、プロジェクトディレクトリのルートに新しいファイル<i>hello.htmlを</i>作成します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">You can input any HTML you want;</span>必要なHTMLを入力できます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Listing 20-4 shows one possibility.</span>リスト20-4は1つの可能性を示しています。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: hello.html</span></span> <span class=filename>ファイル名：hello.html</span></span> </p><br><div data-lang=html><div data-l="&lt;!DOCTYPE html&gt;"></div><div data-l="&lt;html lang=&quot;en&quot;&gt;"></div><div data-l="  &lt;head&gt;"></div><div data-l="    &lt;meta charset=&quot;utf-8&quot;&gt;"></div><div data-l="    &lt;title&gt;Hello!&lt;/title&gt;"></div><div data-l="  &lt;/head&gt;"></div><div data-l="  &lt;body&gt;"></div><div data-l="    &lt;h1&gt;Hello!&lt;/h1&gt;"></div><div data-l="    &lt;p&gt;Hi from Rust&lt;/p&gt;"></div><div data-l="  &lt;/body&gt;"></div><div data-l=&lt;/html&gt;></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-4: A sample HTML file to return in a response</span></span> <span class=caption>リスト20-4：レスポンスで返すサンプルHTMLファイル</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is a minimal HTML5 document with a heading and some text.</span>これは見出しとテキストを含む最小限のHTML5文書です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">To return this from the server when a request is received, we&#39;ll modify <code>handle_connection</code> as shown in Listing 20-5 to read the HTML file, add it to the response as a body, and send it.</span>要求を受け取ったときにこれをサーバーから戻すには、リスト20-5に示すように<code>handle_connection</code>を変更して、HTMLファイルを読み込んで本文として応答に追加して送信します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust><div data-l="# use std::io::prelude::*;"></div><div data-l="# use std::net::TcpStream;"></div><div data-l="use std::fs::File;"></div><div data-l="#// --snip--"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">--snip--</span> --snip--</span> </div><div data-l=""></div><div data-l="fn handle_connection(mut stream: TcpStream) {"></div><div data-l="    let mut buffer = [0; 512];"></div><div data-l="    stream.read(&amp;mut buffer).unwrap();"></div><div data-l=""></div><div data-l="    let mut file = File::open(&quot;hello.html&quot;).unwrap();"></div><div data-l=""></div><div data-l="    let mut contents = String::new();"></div><div data-l="    file.read_to_string(&amp;mut contents).unwrap();"></div><div data-l=""></div><div data-l="    let response = format!(&quot;HTTP/1.1 200 OK\r\n\r\n{}&quot;, contents);"></div><div data-l=""></div><div data-l="    stream.write(response.as_bytes()).unwrap();"></div><div data-l="    stream.flush().unwrap();"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-5: Sending the contents of <i>hello.html</i> as the body of the response</span></span> <span class=caption>リスト20-5： <i>hello.html</i>の内容を<i>レスポンスの本文</i>として送信する</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ve added a line at the top to bring the standard library&#39;s <code>File</code> into scope.</span>一番上に標準ライブラリの<code>File</code>を入れるための行を追加しました。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The code for opening a file and reading the contents should look familiar;</span>ファイルを開いて内容を読むためのコードはよく分かります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">we used it in Chapter 12 when we read the contents of a file for our I/O project in Listing 12-4.</span>リスト12-4のI / Oプロジェクトのファイルの内容を読むときには、第12章でそれを使用しました。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Next, we use <code>format€</code> to add the file&#39;s contents as the body of the success response.</span>次に、ファイルの内容を成功応答の本文として追加するために、 <code>format€</code>を使用し<code>format€</code> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Run this code with <code>cargo run</code> and load <i>127.0.0.1:7878</i> in your browser;</span>ブラウザでこのコードを<code>cargo run</code>とload <i>127.0.0.1:7878</i>で<code>cargo run</code>してください。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">you should see your HTML rendered!</span>あなたのHTMLが表示されるはずです！</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Currently, we&#39;re ignoring the request data in <code>buffer</code> and just sending back the contents of the HTML file unconditionally.</span>現在、 <code>buffer</code>内のリクエストデータを無視し、HTMLファイルのコンテンツを無条件に返送しています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">That means if you try requesting <i>127.0.0.1:7878/something-else</i> in your browser, you&#39;ll still get back this same HTML response.</span>つまり、ブラウザで<i>127.0.0.1:7878/something-else</i>をリクエストすると、同じHTML応答が返されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Our server is very limited and is not what most web servers do.</span>当社のサーバーは非常に限られており、ほとんどのWebサーバーではありません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We want to customize our responses depending on the request and only send back the HTML file for a well-formed request to <i>/</i> .</span>リクエストに応じてレスポンスをカスタマイズし、 <i>/</i>への整形式リクエストのHTMLファイルのみを返送します。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Validating the Request and Selectively Responding</span>要求の検証と選択的応答</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Right now, our web server will return the HTML in the file no matter what the client requested.</span>現在、Webサーバは、クライアントが要求したものに関係なく、HTMLファイルを返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s add functionality to check that the browser is requesting <i>/</i> before returning the HTML file and return an error if the browser requests anything else.</span>のは、ブラウザがHTMLファイルを返す前に<i>/</i>要求していることを確認し、ブラウザが何かを要求した場合、エラーを返すための機能を追加してみましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For this we need to modify <code>handle_connection</code> , as shown in Listing 20-6.</span>このためには、リスト20-6に示すように<code>handle_connection</code>を変更する必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This new code checks the content of the request received against what we know a request for <i>/</i> looks like and adds <code>if</code> and <code>else</code> blocks to treat requests differently.</span>この新しいコードは、受信したリクエストの内容を、 <i>/</i> lookのようなリクエストに対して知っているものと照らし合わせてチェックし、 <code>if</code>および<code>else</code>ブロックを追加してリクエストを別々に扱います。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust><div data-l="# use std::io::prelude::*;"></div><div data-l="# use std::net::TcpStream;"></div><div data-l="# use std::fs::File;"></div><div data-l="#// --snip--"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">--snip--</span> --snip--</span> </div><div data-l=""></div><div data-l="fn handle_connection(mut stream: TcpStream) {"></div><div data-l="    let mut buffer = [0; 512];"></div><div data-l="    stream.read(&amp;mut buffer).unwrap();"></div><div data-l=""></div><div data-l="    let get = b&quot;GET / HTTP/1.1\r\n&quot;;"></div><div data-l=""></div><div data-l="    if buffer.starts_with(get) {"></div><div data-l="        let mut file = File::open(&quot;hello.html&quot;).unwrap();"></div><div data-l=""></div><div data-l="        let mut contents = String::new();"></div><div data-l="        file.read_to_string(&amp;mut contents).unwrap();"></div><div data-l=""></div><div data-l="        let response = format!(&quot;HTTP/1.1 200 OK\r\n\r\n{}&quot;, contents);"></div><div data-l=""></div><div data-l="        stream.write(response.as_bytes()).unwrap();"></div><div data-l="        stream.flush().unwrap();"></div><div data-l="    } else {"></div><div data-l="#        // some other request"></div><div data-l="        // "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">some other request</span>その他のリクエスト</span> </div><div data-l="    }"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-6: Matching the request and handling requests to <i>/</i> differently than other requests</span></span> <span class=caption>リスト20-6：他のリクエストとリクエスト<i>/</i>ハンドリングのリクエストのマッチング</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">First, we hardcode the data corresponding to the <i>/</i> request into the <code>get</code> variable.</span>まず、 <i>/</i> requestに対応するデータを<code>get</code>変数にハードコードします。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Because we&#39;re reading raw bytes into the buffer, we transform <code>get</code> into a byte string by adding the <code>b&quot;&quot;</code> byte string syntax at the start of the content data.</span>生のバイトをバッファに読み込んでいるので、コンテンツデータの先頭に<code>b&quot;&quot;</code>文字列構文を追加して<code>get</code>をバイト列に変換します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then we check whether <code>buffer</code> starts with the bytes in <code>get</code> .</span>次に、 <code>buffer</code>が<code>get</code>内のバイトで始まるかどうかをチェックし<code>get</code> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If it does, it means we&#39;ve received a well-formed request to <i>/</i> , which is the success case we&#39;ll handle in the <code>if</code> block that returns the contents of our HTML file.</span>そうであれば、 <i>/</i>への整形式リクエストを受け取ったことを意味します。これは、HTMLファイルの内容を返す<code>if</code>ブロックで処理する成功例です。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If <code>buffer</code> does <i>not</i> start with the bytes in <code>get</code> , it means we&#39;ve received some other request.</span> <code>buffer</code>が<code>get</code>のバイトで始まら<i>ない</i>場合は、別の要求を受け取ったことを意味します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ll add code to the <code>else</code> block in a moment to respond to all other requests.</span>他のすべてのリクエストに応答するコードを<code>else</code>ブロックに追加します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Run this code now and request <i>127.0.0.1:7878</i> ;</span>今すぐこのコードを実行し、 <i>127.0.0.1</i> ： <i>7878</i>をリクエストしてください。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">you should get the HTML in <i>hello.html</i> .</span> <i>hello.htmlで</i> HTMLを取得する必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If you make any other request, such as <i>127.0.0.1:7878/something-else</i> , you&#39;ll get a connection error like those you saw when running the code in Listing 20-1 and Listing 20-2.</span> <i>127.0.0.1:7878/something-else</i>などの他のリクエストを行うと、リスト20-1とリスト20-2のコードを実行したときに見たような接続エラーが発生します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now let&#39;s add the code in Listing 20-7 to the <code>else</code> block to return a response with the status code 404, which signals that the content for the request was not found.</span>リスト20-7のコードを<code>else</code>ブロックに追加して、要求のコンテンツが見つからなかったことを示すステータスコード404の応答を返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;ll also return some HTML for a page to render in the browser indicating the response to the end user.</span>また、エンドユーザーへの応答を示すブラウザでレンダリングするために、ページ用にいくつかのHTMLを返します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust><div data-l="# use std::io::prelude::*;"></div><div data-l="# use std::net::TcpStream;"></div><div data-l="# use std::fs::File;"></div><div data-l="# fn handle_connection(mut stream: TcpStream) {"></div><div data-l="# if true {"></div><div data-l="#// --snip--"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">--snip--</span> --snip--</span> </div><div data-l=""></div><div data-l="} else {"></div><div data-l="    let status_line = &quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&quot;;"></div><div data-l="    let mut file = File::open(&quot;404.html&quot;).unwrap();"></div><div data-l="    let mut contents = String::new();"></div><div data-l=""></div><div data-l="    file.read_to_string(&amp;mut contents).unwrap();"></div><div data-l=""></div><div data-l="    let response = format!(&quot;{}{}&quot;, status_line, contents);"></div><div data-l=""></div><div data-l="    stream.write(response.as_bytes()).unwrap();"></div><div data-l="    stream.flush().unwrap();"></div><div data-l=}></div><div data-l="# }"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-7: Responding with status code 404 and an error page if anything other than <i>/</i> was requested</span></span> <span class=caption>20-7リスト：ステータスコード404とエラーページで応答<i>/</i>以外のものが要求された場合は</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Here, our response has a status line with status code 404 and the reason phrase <code>NOT FOUND</code> .</span>ここでは、ステータスコード404のステータス行と、 <code>NOT FOUND</code>理由フレーズが表示されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We&#39;re still not returning headers, and the body of the response will be the HTML in the file <i>404.html</i> .</span>私たちはまだヘッダーを返さず、応答の本体は<i>404.html</i>ファイルのHTMLになります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">You&#39;ll need to create a <i>404.html</i> file next to <i>hello.html</i> for the error page;</span>あなたは、エラー・ページ用<i>hello.html</i>の横<i>404.htmlファイル</i>を作成する必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">again feel free to use any HTML you want or use the example HTML in Listing 20-8.</span>リスト20-8のサンプルHTMLを自由に使用しても構いません。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: 404.html</span></span> <span class=filename>ファイル名：404.html</span></span> </p><br><div data-lang=html><div data-l="&lt;!DOCTYPE html&gt;"></div><div data-l="&lt;html lang=&quot;en&quot;&gt;"></div><div data-l="  &lt;head&gt;"></div><div data-l="    &lt;meta charset=&quot;utf-8&quot;&gt;"></div><div data-l="    &lt;title&gt;Hello!&lt;/title&gt;"></div><div data-l="  &lt;/head&gt;"></div><div data-l="  &lt;body&gt;"></div><div data-l="    &lt;h1&gt;Oops!&lt;/h1&gt;"></div><div data-l="    &lt;p&gt;Sorry, I don't know what you're asking for.&lt;/p&gt;"></div><div data-l="  &lt;/body&gt;"></div><div data-l=&lt;/html&gt;></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-8: Sample content for the page to send back with any 404 response</span></span> <span class=caption>リスト20-8：404応答で返送するページのサンプルコンテンツ</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">With these changes, run your server again.</span>これらの変更を加えて、サーバーを再度実行してください。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Requesting <i>127.0.0.1:7878</i> should return the contents of <i>hello.html</i> , and any other request, like <i>127.0.0.1:7878/foo</i> , should return the error HTML from <i>404.html</i> .</span> <i>127.0.0.1:7878を</i>要求すると<i>、hello.html</i>の内容、およびその他の要求を返す必要があります<i>127.0.0.1:7878/foo</i>のように<i>、404.html</i>からのエラーHTMLを返す必要があります。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">A Touch of Refactoring</span>リファクタリングのタッチ</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">At the moment the <code>if</code> and <code>else</code> blocks have a lot of repetition: they&#39;re both reading files and writing the contents of the files to the stream.</span>現時点では、 <code>if</code>ブロックと<code>else</code>ブロックには多くの繰り返しがあります。ファイルを読み込んでいて、ファイルの内容をストリームに書き込んでいます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The only differences are the status line and the filename.</span>唯一の違いは、ステータス行とファイル名です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s make the code more concise by pulling out those differences into separate <code>if</code> and <code>else</code> lines that will assign the values of the status line and the filename to variables;</span>これらの違いを<code>if</code>と<code>else</code>別々の行に引き出し、ステータス行の値とファイル名を変数に割り当てることで、コードをより簡潔にしましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">we can then use those variables unconditionally in the code to read the file and write the response.</span>コード内でこれらの変数を無条件で使用して、ファイルを読み込んで応答を書き込むことができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Listing 20-9 shows the resulting code after replacing the large <code>if</code> and <code>else</code> blocks.</span>コードリスト20-9は、大きな<code>if</code>ブロックと<code>else</code>ブロックを置き換えた結果のコードを示して<code>else</code>ます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=filename>Filename: src/main.rs</span></span> <span class=filename>ファイル名：src / main.rs</span></span> </p><br><div data-lang=rust><div data-l="# use std::io::prelude::*;"></div><div data-l="# use std::net::TcpStream;"></div><div data-l="# use std::fs::File;"></div><div data-l="#// --snip--"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">--snip--</span> --snip--</span> </div><div data-l=""></div><div data-l="fn handle_connection(mut stream: TcpStream) {"></div><div data-l="#     let mut buffer = [0; 512];"></div><div data-l="#     stream.read(&amp;mut buffer).unwrap();"></div><div data-l=#></div><div data-l="#     let get = b&quot;GET / HTTP/1.1\r\n&quot;;"></div><div data-l="#    // --snip--"></div><div data-l="    // "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">--snip--</span> --snip--</span> </div><div data-l=""></div><div data-l="    let (status_line, filename) = if buffer.starts_with(get) {"></div><div data-l="        (&quot;HTTP/1.1 200 OK\r\n\r\n&quot;, &quot;hello.html&quot;)"></div><div data-l="    } else {"></div><div data-l="        (&quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&quot;, &quot;404.html&quot;)"></div><div data-l="    };"></div><div data-l=""></div><div data-l="    let mut file = File::open(filename).unwrap();"></div><div data-l="    let mut contents = String::new();"></div><div data-l=""></div><div data-l="    file.read_to_string(&amp;mut contents).unwrap();"></div><div data-l=""></div><div data-l="    let response = format!(&quot;{}{}&quot;, status_line, contents);"></div><div data-l=""></div><div data-l="    stream.write(response.as_bytes()).unwrap();"></div><div data-l="    stream.flush().unwrap();"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><span class=caption>Listing 20-9: Refactoring the <code>if</code> and <code>else</code> blocks to contain only the code that differs between the two cases</span></span> <span class=caption>リスト20-9： <code>if</code>と<code>else</code>ブロックをリファクタリングして、2つのケースで異なるコードのみを含むようにする</span></span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Now the <code>if</code> and <code>else</code> blocks only return the appropriate values for the status line and filename in a tuple;</span>これで、 <code>if</code>ブロックと<code>else</code>ブロックは、タプル内のステータス行とファイル名に適切な値を返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">we then use destructuring to assign these two values to <code>status_line</code> and <code>filename</code> using a pattern in the <code>let</code> statement, as discussed in Chapter 18.</span>第18章で説明するように、 <code>status_line</code>を使用して、 <code>let</code>文のパターンを使用して<code>status_line</code>と<code>filename</code>にこれらの2つの値を割り当て<code>filename</code> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The previously duplicated code is now outside the <code>if</code> and <code>else</code> blocks and uses the <code>status_line</code> and <code>filename</code> variables.</span>以前に複製されたコードは、 <code>if</code>および<code>else</code>ブロックの外側にあり、 <code>status_line</code>および<code>filename</code>変数を使用します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This makes it easier to see the difference between the two cases, and it means we have only one place to update the code if we want to change how the file reading and response writing work.</span>これにより、2つのケースの違いをより簡単に確認できるようになります。つまり、ファイルの読み書きの仕方を変更したい場合は、コードを更新する場所が1つだけです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The behavior of the code in Listing 20-9 will be the same as that in Listing 20-8.</span>リスト20-9のコードの動作は、リスト20-8のコードの動作と同じです。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Awesome!</span>驚くばかり！</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We now have a simple web server in approximately 40 lines of Rust code that responds to one request with a page of content and responds to all other requests with a 404 response.</span> 1つのリクエストで1ページの内容で応答し、他のすべてのリクエストに404レスポンスで応答する、約40行のRustコードでシンプルなWebサーバーを使用できるようになりました。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Currently, our server runs in a single thread, meaning it can only serve one request at a time.</span>現在のところ、当社のサーバーは単一のスレッドで実行されます。つまり、一度に1つの要求のみを処理できます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Let&#39;s examine how that can be a problem by simulating some slow requests.</span>遅いリクエストをシミュレートすることで、その問題がどのようになるかを調べてみましょう。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then we&#39;ll fix it so our server can handle multiple requests at once.</span>その後、私たちのサーバーが複数のリクエストを同時に処理できるように修正します。</span> </p><script>_addload(function(){_setupIW('com');_csi('en','ja','ch20-01-single-threaded.html');});</script>