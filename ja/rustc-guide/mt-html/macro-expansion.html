<!DOCTYPE html><html lang=ja-x-mtfrom-en><head><script>(function(){(function(){function e(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp("CSI/"+a)}catch(h){}};this.tick("start",null,a)}var a;if(window.performance)var d=(a=window.performance.timing)&&a.responseStart;var f=0<d?new e(d):new e;window.jstiming={Timer:e,load:f};if(a){var c=a.navigationStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick("_wtsrt",void 0,c),b.tick("wtsrt_","_wtsrt",
d),b.tick("tbsd_","wtsrt_"))}try{a=null,window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick("_tbnd",void 0,window.chrome.csi().startE),b.tick("tbnd_","_tbnd",c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick("_tbnd",void 0,window.external.startE),b.tick("tbnd_","_tbnd",c))),a&&(window.jstiming.pt=a)}catch(g){}})();}).call(window);
</script><script src="https://translate.googleusercontent.com/translate/releases/twsfe_w_20180723_RC00/r/js/translate_c.js"></script><script>_intlStrings._originalText = "英語の原文テキスト:";_intlStrings._interfaceDirection="ltr";_intlStrings._interfaceAlign="left";_intlStrings._langpair="en|ja";_intlStrings._feedbackUrl="https://translate.google.com/translate_suggestion";_intlStrings._currentBy="%1$s に %2$s により翻訳されました";_intlStrings._unknown="不明";_intlStrings._suggestTranslation="翻訳を改善する"  ;_intlStrings._submit="送信";_intlStrings._suggestThanks="Google 翻訳の改善にご協力いただきありがとうございました。";_intlStrings._reverse=false;_intlStrings._staticContentPath="https://www.gstatic.com/translate/infowindow/";</script><style type="text/css">.google-src-text {display: none !important} .google-src-active-text {display: block!important;color:black!important; font-size:12px!important;font-family:arial,sans-serif!important}.google-src-active-text a {font-size:12px!important}.google-src-active-text a:link {color:#00c!important;text-decoration:underline!important}.google-src-active-text a:visited {color:purple!important;text-decoration:underline!important}.google-src-active-text a:active {color:red!important;text-decoration:underline!important}</style><meta http-equiv="X-Translated-By" content="Google"><link href=macro-expansion.html hreflang=en rel="alternate machine-translated-from"><base href="" target=_top /></head><body><iframe src="https://translate.google.com/translate_un?hl=ja&prev=_t&sl=en&tl=ja&lang=en&usg=ALkJrhi1BDLmdbWiRXYMNxkaJ7TdmUrvmA" width=0 height=0 frameborder=0 style="width:0px;height:0px;border:0px;display:none;"></iframe><h1> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Macro expansion</span>マクロ展開</span> </h1><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Macro expansion happens during parsing.</span>マクロ展開は解析中に行われます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>rustc</code> has two parsers, in fact: the normal Rust parser, and the macro parser.</span> <code>rustc</code>は実際には2つのパーサがあります。通常のRustパーサとマクロパーサです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">During the parsing phase, the normal Rust parser will set aside the contents of macros and their invocations.</span>解析段階では、通常のRustパーサーはマクロとその呼び出しの内容を脇に置いています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Later, before name resolution, macros are expanded using these portions of the code.</span>後で、名前解決の前に、これらのコード部分を使用してマクロが展開されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro parser, in turn, may call the normal Rust parser when it needs to bind a metavariable (eg <code>$my_expr</code> ) while parsing the contents of a macro invocation.</span>マクロパーサは、マクロ呼び出しの内容を解析中に<code>$my_expr</code>変数（例えば<code>$my_expr</code> ）をバインドする必要がある場合、通常のRustパーサーを呼び出すことができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The code for macro expansion is in <a class=notranslate href=#3code_dir><code>src/libsyntax/ext/tt/</code></a> .</span>マクロ展開のためのコードは<a class=notranslate href=#3code_dir><code>src/libsyntax/ext/tt/</code></a>ます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This chapter aims to explain how macro expansion works.</span>この章では、マクロ展開のしくみについて説明します。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Example</span>例</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It&#39;s helpful to have an example to refer to.</span>参照する例があると便利です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For the remainder of this chapter, whenever we refer to the &quot;example <s>definition</s> &quot;, we mean the following:</span>この章の残りの部分では、「サンプル<s>定義</s> 」を参照するときはいつでも、次のことを意味します。</span> </p><br><div data-lang=rust,ignore><div data-l="macro_rules! printer {"></div><div data-l="    (print $mvar:ident) =&gt; {"></div><div data-l="        println!(&quot;{}&quot;, $mvar);"></div><div data-l="    }"></div><div data-l="    (print twice $mvar:ident) =&gt; {"></div><div data-l="        println!(&quot;{}&quot;, $mvar);"></div><div data-l="        println!(&quot;{}&quot;, $mvar);"></div><div data-l="    }"></div><div data-l=}></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>$mvar</code> is called a <s>metavariable</s> .</span> <code>$mvar</code> <s>メタ変数</s>と呼ばれています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Unlike normal variables, rather than binding to a value in a computation, a metavariable binds <s>at compile time</s> to a tree of <s>tokens</s> .</span>通常の変数とは異なり、計算の値にバインドするのではなく、メタ変数は<s>コンパイル時</s>に<s>トークンの</s>ツリーにバインドさ<s>れます</s> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">A <s>token</s> is a single &quot;unit&quot; of the grammar, such as an identifier (eg <code>foo</code> ) or punctuation (eg <code>=&gt;</code> ).</span> <s>トークン</s>は、識別子（例えば、 <code>foo</code> ）または句読点（例えば、 <code>=&gt;</code> ）のような、文法の単一の「単位」である。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">There are also other special tokens, such as <code>EOF</code> , which indicates that there are no more tokens.</span>さらにトークンがないことを示す<code>EOF</code>などの特別なトークンもあります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Token trees resulting from paired parentheses-like characters ( <code>(</code> ... <code>)</code> , <code>[</code> ... <code>]</code> , and <code>{</code> ... <code>}</code> ) – they include the open and close and all the tokens in between (we do require that parentheses-like characters be balanced).</span> <code>(</code> ... <code>)</code> 、 <code>[</code> ... <code>]</code> 、および<code>{</code> ... <code>}</code> ）の対になったトークンツリー - それらには開閉とすべてのトークンが含まれています（カッコのような文字をバランスさせる）。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Having macro expansion operate on token streams rather than the raw bytes of a source file abstracts away a lot of complexity.</span>マクロ展開がソースファイルの生のバイトではなくトークンストリームで動作することは、多くの複雑さを抽象化します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro expander (and much of the rest of the compiler) doesn&#39;t really care that much about the exact line and column of some syntactic construct in the code;</span>マクロエキスパンダー（およびその他の多くのコンパイラ）は、コード内の構文構造の正確な行と列についてはそれほど気にしません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">it cares about what constructs are used in the code.</span>コード内でどのような構文が使用されているかが気になります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Using tokens allows us to care about <s>what</s> without worrying about <s>where</s> .</span>トークンを使用することで、 <s>どこ</s>を気にせずに気にすること<s>ができ</s>ます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For more information about tokens, see the <a class=notranslate href=#3parsing>Parsing</a> chapter of this book.</span>トークンの詳細については、この<a class=notranslate href=#3parsing>Parsing</a> 「 <a class=notranslate href=#3parsing>Parsing</a>章を参照してください。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Whenever we refer to the &quot;example <s>invocation</s> &quot;, we mean the following snippet:</span> 「サンプル<s>呼び出し</s> 」を参照するたびに、次のスニペットを意味します。</span> </p><br><div data-lang=rust,ignore><div data-l="#//printer!(print foo); // Assume `foo` is a variable defined somewhere else..."></div><div data-l="printer!(print foo); // "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Assume <code>foo</code> is a variable defined somewhere else...</span> <code>foo</code>は他のどこかで定義された変数であると仮定します...</span> </div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The process of expanding the macro invocation into the syntax tree <code>println€(&quot;{}&quot;, foo)</code> and then expanding that into a call to <code>Display::fmt</code> is called <s>macro expansion</s> , and it is the topic of this chapter.</span>マクロ呼び出しを構文木<code>println€(&quot;{}&quot;, foo)</code>に展開し、それを<code>Display::fmt</code>呼び出しに展開するプロセスは、 <s>マクロ展開</s>と呼ばれ、この章のトピックです。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro parser</span>マクロパーサー</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">There are two parts to macro expansion: parsing the definition and parsing the invocations.</span>マクロ拡張には、定義の解析と呼び出しの解析という2つの部分があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Interestingly, both are done by the macro parser.</span>興味深いことに、両方ともマクロパーサによって行われます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Basically, the macro parser is like an NFA-based regex parser.</span>基本的には、マクロパーサはNFAベースの正規表現パーサーのようなものです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It uses an algorithm similar in spirit to the <a href=#2https://en.wikipedia.org/wiki/Earley_parser>Earley parsing algorithm</a> .</span>これは、 <a href=#2https://en.wikipedia.org/wiki/Earley_parser>Earley構文解析アルゴリズム</a>と似たアルゴリズムを使用し<a href=#2https://en.wikipedia.org/wiki/Earley_parser>ます</a> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro parser is defined in <a class=notranslate href=#3code_mp><code>src/libsyntax/ext/tt/macro_parser.rs</code></a> .</span>マクロパーサは、 <a class=notranslate href=#3code_mp><code>src/libsyntax/ext/tt/macro_parser.rs</code></a>定義されています。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The interface of the macro parser is as follows (this is slightly simplified):</span>マクロパーサのインタフェースは次のとおりです（これは少し簡略化されています）：</span> </p><br><div data-lang=rust,ignore><div data-l="fn parse("></div><div data-l="    sess: ParserSession,"></div><div data-l="    tts: TokenStream,"></div><div data-l="    ms: &amp;[TokenTree]"></div><div data-l=") -&gt; NamedParseResult"></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In this interface:</span>このインタフェースでは、</span> </p><br><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>sess</code> is a &quot;parsing session&quot;, which keeps track of some metadata.</span> <code>sess</code>は「解析セッション」で、メタデータを追跡します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Most notably, this is used to keep track of errors that are generated so they can be reported to the user.</span>特に、生成されたエラーを追跡してユーザーに報告できるようにするために使用されます。</span> </div><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>tts</code> is a stream of tokens.</span> <code>tts</code>はトークンのストリームです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro parser&#39;s job is to consume the raw stream of tokens and output a binding of metavariables to corresponding token trees.</span>マクロパーサの仕事は、トークンの生ストリームを消費し、メタ変数の対応するトークンツリーへのバインディングを出力することです。</span> </div><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>ms</code> a <s>matcher</s> .</span> <code>ms</code> <s>マッチャー</s> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is a sequence of token trees that we want to match <code>tts</code> against.</span>これは、 <code>tts</code>と照合したいトークンツリーのシーケンスです。</span> </div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In the analogy of a regex parser, <code>tts</code> is the input and we are matching it against the pattern <code>ms</code> .</span>正規表現パーサの類推では、 <code>tts</code>は入力であり、パターン<code>ms</code>と一致しています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Using our examples, <code>tts</code> could be the stream of tokens containing the inside of the example invocation <code>print foo</code> , while <code>ms</code> might be the sequence of token (trees) <code>print $mvar:ident</code> .</span>私たちの例を使って、 <code>tts</code>は、例の<code>print foo</code>内部を含むトークンのストリームであり、 <code>ms</code>はトークン（ツリー） <code>print $mvar:ident</code>のシーケンスかもしれません。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The output of the parser is a <code>NamedParseResult</code> , which indicates which of three cases has occured:</span>パーサーの出力は<code>NamedParseResult</code> 、3つのケースのどれが発生したかを示します。</span> </p><br><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Success: <code>tts</code> matches the given matcher <code>ms</code> , and we have produced a binding from metavariables to the corresponding token trees.</span>成功： <code>tts</code>は与えられたマッチャー<code>ms</code>と一致し、メタ変数から対応するトークンツリーへのバインディングを生成しました。</span> </div><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Failure: <code>tts</code> does not match <code>ms</code> .</span>失敗： <code>tts</code>は<code>ms</code>一致しません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This results in an error message such as &quot;No rule expected token <s>blah</s> &quot;.</span>この結果、「No rule expected token <s>blah</s> 」のようなエラーメッセージが表示されます。</span> </div><div data-b=-> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Error: some fatal error has occured <s>in the parser</s> .</span>エラー： <s>パーサで</s>致命的なエラーが発生<s>し</s>まし<s>た</s> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For example, this happens if there are more than one pattern match, since that indicates the macro is ambiguous.</span>たとえば、複数のパターンマッチがある場合は、マクロがあいまいであることを示します。</span> </div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The full interface is defined <a class=notranslate href=#3code_parse_int>here</a> .</span>完全なインタフェースが<a class=notranslate href=#3code_parse_int>here</a>で定義されてい<a class=notranslate href=#3code_parse_int>here</a> 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The macro parser does pretty much exactly the same as a normal regex parser with one exception: in order to parse different types of metavariables, such as <code>ident</code> , <code>block</code> , <code>expr</code> , etc., the macro parser must sometimes call back to the normal Rust parser.</span>マクロパーサーは<code>ident</code> 、 <code>block</code> 、 <code>expr</code>などのさまざまな種類のメタ変数を解析するために、通常の正規表現パーサと同じように動作します。 。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">As mentioned above, both definitions and invocations of macros are parsed using the macro parser.</span>前述のように、マクロの定義と呼び出しは、マクロパーサーを使用して解析されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">This is extremely non-intuitive and self-referential.</span>これは非常に非直感的で自己参照的です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The code to parse macro <s>definitions</s> is in <a class=notranslate href=#3code_mr><code>src/libsyntax/ext/tt/macro_rules.rs</code></a> .</span>マクロ<s>定義</s>を解析するコードは、 <a class=notranslate href=#3code_mr><code>src/libsyntax/ext/tt/macro_rules.rs</code></a>ます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">It defines the pattern for matching for a macro definition as <code>$( $lhs:tt =&gt; $rhs:tt );+</code> .</span>これは、 <code>$( $lhs:tt =&gt; $rhs:tt );+</code>マクロ定義の一致パターンを定義し<code>$( $lhs:tt =&gt; $rhs:tt );+</code> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In other words, a <code>macro_rules</code> defintion should have in its body at least one occurence of a token tree followed by <code>=&gt;</code> followed by another token tree.</span>言い換えれば、 <code>macro_rules</code>定義は、本体に少なくとも1つのトークンツリーの出現があり、その後に<code>=&gt;</code>続き、別のトークンツリーが続くはずです。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">When the compiler comes to a <code>macro_rules</code> definition, it uses this pattern to match the two token trees per rule in the definition of the macro <s>using the macro parser itself</s> .</span>コンパイラが<code>macro_rules</code>定義に来ると、このパターンを使用して、このパターンを<s>使用して、マクロパーサ自体を使用して</s> 、マクロ定義内のルールごとに2つのトークンツリーを照合します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In our example definition, the metavariable <code>$lhs</code> would match the patterns of both arms: <code>(print $mvar:ident)</code> and <code>(print twice $mvar:ident)</code> .</span>この例の定義では、メタ<code>$lhs</code>は、 <code>(print $mvar:ident)</code>と<code>(print twice $mvar:ident)</code> <code>(print $mvar:ident)</code>両方のパターンのパターンと一致します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">And <code>$rhs</code> would match the bodies of both arms: <code>{ println€(&quot;{}&quot;, $mvar); }</code></span>そして、 <code>$rhs</code>は両腕のボディにマッチします： <code>{ println€(&quot;{}&quot;, $mvar); }</code></span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>{ println€(&quot;{}&quot;, $mvar); }</code> and <code>{ println€(&quot;{}&quot;, $mvar); println€(&quot;{}&quot;, $mvar); }</code></span> <code>{ println€(&quot;{}&quot;, $mvar); }</code>と<code>{ println€(&quot;{}&quot;, $mvar); println€(&quot;{}&quot;, $mvar); }</code></span> <code>{ println€(&quot;{}&quot;, $mvar); println€(&quot;{}&quot;, $mvar); }</code> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><code>{ println€(&quot;{}&quot;, $mvar); println€(&quot;{}&quot;, $mvar); }</code> .</span> <code>{ println€(&quot;{}&quot;, $mvar); println€(&quot;{}&quot;, $mvar); }</code> 。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The parser would keep this knowledge around for when it needs to expand a macro invocation.</span>パーサは、マクロ呼び出しを拡張する必要があるときに、この知識を保持します。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">When the compiler comes to a macro invocation, it parses that invocation using the same NFA-based macro parser that is described above.</span>コンパイラがマクロ呼び出しになると、コンパイラは上記の同じNFAベースのマクロパーサを使用してその呼び出しを解析します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">However, the matcher used is the first token tree ( <code>$lhs</code> ) extracted from the arms of the macro <s>definition</s> .</span>しかし、使用されるマッチャーは、マクロ<s>定義の</s>アームから抽出された最初のトークンツリー（ <code>$lhs</code> ）です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Using our example, we would try to match the token stream <code>print foo</code> from the invocation against the matchers <code>print $mvar:ident</code> and <code>print twice $mvar:ident</code> that we previously extracted from the definition.</span>この例では、呼び出し元の<code>print foo</code>のトークンストリームを、 <code>print $mvar:ident</code>というマッチャーの<code>print $mvar:ident</code>とマッチさせようとします。そして、定義から前に抽出した<code>print twice $mvar:ident</code>を行います。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The algorithm is exactly the same, but when the macro parser comes to a place in the current matcher where it needs to match a <s>non-terminal</s> (eg <code>$mvar:ident</code> ), it calls back to the normal Rust parser to get the contents of that non-terminal.</span>アルゴリズムはまったく同じですが、マクロパーサーは<s>、非末端と</s>一致する必要<s>が</s>あり、現在のマッチャー内の場所（例えばに来るとき<code>$mvar:ident</code> ）、それはの内容を取得するために、通常の錆パーサーにコールバックしますその非終端。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In this case, the Rust parser would look for an <code>ident</code> token, which it finds ( <code>foo</code> ) and returns to the macro parser.</span>この場合、Rustパーサーは<code>ident</code>トークンを探し、それを見つけ（ <code>foo</code> ）、マクロパーサに返します。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then, the macro parser proceeds in parsing as normal.</span>次に、マクロパーサは通常通り解析を続けます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Also, note that exactly one of the matchers from the various arms should match the invocation;</span>また、さまざまな武器のマッチャーのうちの1つが呼び出しに一致する必要があります。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">if there is more than one match, the parse is ambiguous, while if there are no matches at all, there is a syntax error.</span>複数の一致がある場合は解析があいまいで、一致が全くない場合は構文エラーがあります。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For more information about the macro parser&#39;s implementation, see the comments in <a class=notranslate href=#3code_mp><code>src/libsyntax/ext/tt/macro_parser.rs</code></a> .</span>マクロパーサの実装の詳細については、 <a class=notranslate href=#3code_mp><code>src/libsyntax/ext/tt/macro_parser.rs</code></a>のコメントを参照してください。</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Hygiene</span>衛生</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">If you have ever used C/C++ preprocessor macros, you know that there are some annoying and hard-to-debug gotchas!</span>これまでにC / C ++プリプロセッサマクロを使用したことがある人は、厄介で難しい問題があることを知っています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For example, consider the following C code:</span>たとえば、次のCコードを考えてみましょう。</span> </p><br><div data-lang=c><div data-l="#define DEFINE_FOO struct Bar {int x;}; struct Foo {Bar bar;};"></div><div data-l=""></div><div data-l="#// Then, somewhere else"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then, somewhere else</span>次に、他のどこか</span> </div><div data-l="struct Bar {"></div><div data-l="    ..."></div><div data-l=};></div><div data-l=""></div><div data-l=DEFINE_FOO></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Most people avoid writing C like this – and for good reason: it doesn&#39;t compile.</span>ほとんどの人はこのようにCを書くのを避けます。正当な理由でそれはコンパイルされません。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">The <code>struct Bar</code> defined by the macro clashes names with the <code>struct Bar</code> defined in the code.</span> <code>struct Bar</code>でマクロ衝突名で定義された<code>struct Bar</code>コードで定義されています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Consider also the following example:</span>以下の例も考慮してください。</span> </p><br><div data-lang=c><div data-l="#define DO_FOO(x) {\"></div><div data-l="    int y = 0;\"></div><div data-l="    foo(x, y);\"></div><div data-l="    }"></div><div data-l=""></div><div data-l="#// Then elsewhere"></div><div data-l="// "> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Then elsewhere</span>それ以外の場所</span> </div><div data-l="int y = 22;"></div><div data-l=DO_FOO(y);></div></div><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Do you see the problem?</span>あなたは問題が見えますか？</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We wanted to generate a call <code>foo(22, 0)</code> , but instead we got <code>foo(0, 0)</code> because the macro defined its own <code>y</code> !</span>私たちは、コール生成したかった<code>foo(22, 0)</code>が、代わりに我々は持っ<code>foo(0, 0)</code>マクロは、独自の定義されたので、 <code>y</code> ！</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">These are both examples of <s>macro hygiene</s> issues.</span>これらは両方とも<s>マクロ衛生</s>問題の例です。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><s>Hygiene</s> relates to how to handle names defined <s>within a macro</s> .</span> <s>衛生</s> <s>は、マクロ内で</s>定義さ<s>れた</s>名前を処理する方法に関連しています。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In particular, a hygienic macro system prevents errors due to names introduced within a macro.</span>特に、衛生的なマクロシステムは、マクロ内に導入された名前によるエラーを防ぎます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Rust macros are hygienic in that they do not allow one to write the sorts of bugs above.</span> Rustマクロは、上のような種類のバグを書くことができないという点で衛生的です。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">At a high level, hygiene within the rust compiler is accomplished by keeping track of the context where a name is introduced and used.</span>高レベルでは、rustコンパイラ内の衛生は、名前が導入され使用されるコンテキストを追跡することによって達成されます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">We can then disambiguate names based on that context.</span>そのコンテキストに基づいて名前を明確にすることができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Future iterations of the macro system will allow greater control to the macro author to use that context.</span>マクロシステムの今後の反復は、マクロ作成者がそのコンテキストを使用するように制御することを可能にする。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">For example, a macro author may want to introduce a new name to the context where the macro was called.</span>たとえば、マクロ作成者は、マクロが呼び出されたコンテキストに新しい名前を導入することができます。</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Alternately, the macro author may be defining a variable for use only within the macro (ie it should not be visible outside the macro).</span>あるいは、マクロ作成者は、マクロ内でのみ使用する変数を定義している可能性があります（つまり、マクロの外側には表示しないでください）。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">In rustc, this &quot;context&quot; is tracked via <code>Span</code> s.</span> rustcでは、この「コンテキスト」は<code>Span</code>によって追跡されます。</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TODO: what is call-site hygiene?</span> TODO：コールサイト衛生とは何ですか？</span> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">what is def-site hygiene?</span>デフサイト衛生とは何ですか？</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TODO</span> TODO</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Procedural Macros</span>手続き型マクロ</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TODO</span> TODO</span> </p><br><h3> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">Custom Derive</span>カスタム作成</span> </h3><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TODO</span> TODO</span> </p><br><p> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left">TODO: maybe something about macros 2.0?</span> TODO：マクロ2.0についての何か？</span> </p><br><br> <span class="notranslate" onmouseover="_tipon(this)" onmouseout="_tipoff()"><span class="google-src-text" style="direction: ltr; text-align: left"><a class=notranslate href=#1https://github.com/rust-lang/rust/tree/master/src/libsyntax/ext/tt>code_dir</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_parser/>code_mp</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_rules/>code_mr</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_parser/fn.parse.html>code_parse_int</a> <a class=notranslate href=#1./the-parser.html>parsing</a></span> <a class=notranslate href=#1https://github.com/rust-lang/rust/tree/master/src/libsyntax/ext/tt>code_dir</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_parser/>code_mp</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_rules/>code_mr</a> <a class=notranslate href=#1https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ext/tt/macro_parser/fn.parse.html>code_parse_int</a> <a class=notranslate href=#1./the-parser.html>parsing</a></span><script>_addload(function(){_setupIW('com');_csi('en','ja','macro-expansion.html');});</script>